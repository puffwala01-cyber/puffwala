<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>Staff Attendance</title>
  <style>
    :root { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial; }
    body { margin:0; background:#f6f6f7; color:#111; }
    header { padding:14px 16px; background:#fff; border-bottom:1px solid #e6e6e9; position:sticky; top:0; z-index:5;}
    header h1 { margin:0; font-size:18px; }
    .wrap { padding:16px; max-width:860px; margin:0 auto; }
    .card { background:#fff; border:1px solid #e6e6e9; border-radius:16px; padding:14px; margin-bottom:12px; box-shadow:0 1px 0 rgba(0,0,0,.02); }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button { border:0; border-radius:14px; padding:12px 14px; font-weight:800; background:#111; color:#fff; }
    button.secondary { background:#e9e9ee; color:#111; }
    button.danger { background:#c62828; }
    button:disabled { opacity:.5; }
    input, select, textarea { width:100%; padding:12px; border-radius:14px; border:1px solid #d7d7dc; background:#fff; }
    .muted { color:#666; font-size:13px; }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#f0f0f4; font-size:12px; }
    .hidden { display:none !important; }
    .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#111; color:#fff; padding:10px 14px; border-radius:14px; display:none; z-index:10; }
    .staffBtn { width:100%; text-align:left; background:#fff; color:#111; border:1px solid #e6e6e9; }
    .staffBtn:active { transform: scale(0.99); }
    .kbd { display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:10px; }
    .key { font-size:22px; padding:16px 0; border-radius:16px; background:#fff; border:1px solid #e6e6e9; color:#111; font-weight:900; }
    .pinDots { letter-spacing:6px; font-size:22px; font-weight:900; text-align:center; }
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; padding:10px 8px; border-bottom:1px solid #eee; font-size:14px; }
    th { color:#555; font-weight:900; font-size:12px; text-transform:uppercase; letter-spacing:.04em;}
    .right { text-align:right; }
    .tabs { display:flex; gap:8px; }
    .tab { flex:1; }
    .warn { background:#fff3cd; border:1px solid #ffeeba; color:#856404; }
  </style>
</head>
<body>
<header>
  <div class="row" style="align-items:center;">
    <h1 style="flex:1;">Staff Attendance (Online)</h1>
    <span id="cloudPill" class="pill">Cloud: off</span>
  </div>
</header>

<div class="wrap">

  <!-- First-run setup -->
  <div id="setupCard" class="card hidden">
    <h2 style="margin:0 0 8px 0;">Set Manager PIN</h2>
    <div class="muted">6 digits. Don‚Äôt share it with staff.</div>
    <div style="height:10px"></div>
    <div class="row">
      <div><input id="setupPin1" inputmode="numeric" maxlength="6" placeholder="Enter 6-digit PIN" /></div>
      <div><input id="setupPin2" inputmode="numeric" maxlength="6" placeholder="Re-enter PIN" /></div>
    </div>
    <div style="height:10px"></div>
    <button id="setupSave">Save Manager PIN</button>
    <div id="setupErr" class="muted" style="color:#c62828; margin-top:8px;"></div>
  </div>

  <!-- KIOSK HOME: Staff list -->
  <div id="kioskHome" class="card">
    <div class="row">
      <h2 style="margin:0; flex:1;">Kiosk</h2>
      <span id="kioskPill" class="pill">Select your name</span>
    </div>
    <div class="muted">Tap your name ‚Üí enter PIN ‚Üí Clock In/Out ‚Üí Done</div>
    <div style="height:10px"></div>

    <div id="staffButtons"></div>

    <div style="height:12px"></div>
    <button class="secondary" id="btnManagerFromKiosk" style="width:100%;">Manager Control</button>
    <div class="muted" style="margin-top:8px;">Tip: keep this device on the counter.</div>
  </div>

  <!-- PIN modal -->
  <div id="pinCard" class="card hidden">
    <div class="row">
      <h2 style="margin:0; flex:1;">Enter PIN</h2>
      <button class="secondary" id="pinCancel">Cancel</button>
    </div>
    <div class="muted">Staff: <strong id="pinStaffName"></strong></div>
    <div style="height:10px"></div>
    <div id="pinDots" class="pinDots">----</div>
    <div style="height:10px"></div>

    <div class="kbd" id="keypad"></div>

    <div style="height:12px"></div>
    <div class="row">
      <button id="btnClockIn" style="flex:1;" disabled>Clock In</button>
      <button id="btnClockOut" style="flex:1;" disabled>Clock Out</button>
    </div>
    <div id="pinMsg" class="muted" style="margin-top:10px;"></div>
  </div>

  <!-- Manager Gate -->
  <div id="mgrGateCard" class="card hidden">
    <h2 style="margin:0 0 8px 0;">Manager Access</h2>
    <div class="muted">Enter 6-digit Manager PIN</div>
    <div style="height:10px"></div>
    <input id="mgrPin" inputmode="numeric" maxlength="6" placeholder="6-digit PIN" />
    <div style="height:10px"></div>
    <div class="row">
      <button id="mgrUnlock">Unlock</button>
      <button class="secondary" id="mgrCancel">Cancel</button>
    </div>
    <div id="mgrErr" class="muted" style="color:#c62828; margin-top:8px;"></div>
  </div>

  <!-- Manager Area -->
  <div id="managerCard" class="card hidden">
    <div class="row">
      <h2 style="margin:0; flex:1;">Manager</h2>
      <button class="secondary" id="mgrLock">Lock</button>
    </div>

    <div style="height:10px"></div>
    <div class="tabs">
      <button class="tab secondary" id="tabStaff">Staff</button>
      <button class="tab secondary" id="tabTimes">Timesheets</button>
      <button class="tab secondary" id="tabExport">Export/Backup</button>
    </div>

    <div style="height:12px"></div>

    <!-- Staff tab -->
    <div id="paneStaff">
      <div class="card" style="margin:0; border-radius:14px;">
        <h3 style="margin:0 0 10px 0;">Add / Edit Staff</h3>
        <div class="row">
          <div><input id="sName" placeholder="Name" /></div>
          <div><input id="sPin" inputmode="numeric" maxlength="4" placeholder="4-digit PIN" /></div>
          <div><input id="sRate" inputmode="decimal" placeholder="Hourly Rate (¬£)" /></div>
        </div>
        <div style="height:10px"></div>
        <div class="row">
          <button id="staffSave">Save Staff</button>
          <button class="secondary" id="staffReset">Reset</button>
          <button class="danger" id="staffDeactivate" disabled>Deactivate</button>
        </div>
        <div id="staffErr" class="muted" style="color:#c62828; margin-top:8px;"></div>
      </div>

      <div style="height:10px"></div>
      <div class="card" style="margin:0; border-radius:14px;">
        <div class="row">
          <div><strong>Staff List</strong></div>
          <div class="right"><span class="muted">Tap a staff to edit</span></div>
        </div>
        <div style="height:8px"></div>
        <div id="staffList"></div>
      </div>
    </div>

    <!-- Timesheets tab -->
    <div id="paneTimes" class="hidden">
      <div class="card" style="margin:0; border-radius:14px;">
        <div class="row">
          <div>
            <div class="muted">Month</div>
            <input id="monthPick" type="month" />
          </div>
          <div class="right">
            <button class="secondary" id="refreshTimes">Refresh</button>
          </div>
        </div>
        <div id="timesWarn" class="card warn hidden" style="margin-top:12px; border-radius:14px;">
          <strong>Warning:</strong> There are open shifts. Fix them before payroll export.
        </div>
        <div style="height:10px"></div>
        <div id="timesTable"></div>
      </div>

      <div style="height:10px"></div>
      <div class="card" style="margin:0; border-radius:14px;">
        <strong>Open Shifts (tap close)</strong>
        <div class="muted">Only open shifts are shown here.</div>
        <div style="height:8px"></div>
        <div id="openShifts"></div>
      </div>
    </div>

    <!-- Export tab -->
    <div id="paneExport" class="hidden">
      <div class="card" style="margin:0; border-radius:14px;">
        <h3 style="margin:0 0 10px 0;">CSV Export (Monthly Payroll)</h3>
        <div class="row">
          <div>
            <div class="muted">Month</div>
            <input id="exportMonth" type="month" />
          </div>
          <div class="right">
            <button id="btnExportCSV">Generate CSV</button>
          </div>
        </div>
        <div style="height:10px"></div>
        <textarea id="csvOut" rows="8" placeholder="CSV will appear here..."></textarea>
        <div style="height:10px"></div>
        <div class="row">
          <button class="secondary" id="btnCopyCSV">Copy CSV</button>
          <button class="secondary" id="btnDownloadCSV">Download CSV</button>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="card" style="margin:0; border-radius:14px;">
        <h3 style="margin:0 0 10px 0;">Backup / Restore</h3>
        <div class="muted">Cloud sync helps, but still keep backups.</div>
        <div style="height:10px"></div>
        <div class="row">
          <button class="secondary" id="btnBackup">Generate Backup JSON</button>
          <button class="secondary" id="btnRestore">Restore from JSON</button>
        </div>
        <div style="height:10px"></div>
        <textarea id="backupOut" rows="8" placeholder="Backup JSON appears here..."></textarea>
        <div style="height:10px"></div>
        <div class="row">
          <button class="secondary" id="btnCopyBackup">Copy Backup</button>
          <button class="danger" id="btnWipe">WIPE ALL DATA</button>
        </div>
        <div id="wipeErr" class="muted" style="color:#c62828; margin-top:8px;"></div>
      </div>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<!-- Firebase (optional but recommended for online sync) -->
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

<script>
/*** ====== CONFIG: PASTE YOUR FIREBASE CONFIG HERE ======
const firebaseConfig = { ... };
======================================================== */
const firebaseConfig = null; // <-- replace null with your config object

/*** Storage + state ***/
const KEY_LOCAL = "ATT_APP_V2_LOCAL";
const KEY_TENANT = "ATT_TENANT_ID"; // one shop
const defaultState = () => ({
  settings: { managerPinHash: "" },
  staff: [],   // {id,name,pinHash,rate,isActive}
  shifts: []   // {id,staffId,in,out,editedByManager,notes}
});

let state = loadLocal();
let tenantId = localStorage.getItem(KEY_TENANT) || "default_shop"; // you can change later
let cloud = { enabled:false, db:null, doc:null, unsub:null, pushTimer:null, lastRemoteTs:0 };

function loadLocal(){
  try{
    const raw = localStorage.getItem(KEY_LOCAL);
    if(!raw) return defaultState();
    const s = JSON.parse(raw);
    return Object.assign(defaultState(), s);
  } catch { return defaultState(); }
}
function saveLocal(){
  localStorage.setItem(KEY_LOCAL, JSON.stringify(state));
  scheduleCloudPush();
}
function uid(){ return crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random(); }

/*** Lightweight hash (local kiosk) ***/
function hash(str){
  let h = 2166136261;
  for (let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h += (h<<1) + (h<<4) + (h<<7) + (h<<8) + (h<<24);
  }
  return ("00000000" + (h>>>0).toString(16)).slice(-8);
}

/*** UI helpers ***/
const $ = sel => document.querySelector(sel);
function toast(msg){
  const t = $("#toast");
  t.textContent = msg;
  t.style.display = "block";
  setTimeout(()=> t.style.display="none", 1600);
}
function show(el,on=true){ el.classList.toggle("hidden", !on); }
function isDigits(s){ return /^[0-9]+$/.test(s); }
function money2(x){ return Math.round(x*100)/100; }
function fmtGBP(x){ return "¬£" + money2(x).toFixed(2); }
function ymd(d){
  const dt = new Date(d);
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,"0");
  const da = String(dt.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
function hm(d){
  const dt = new Date(d);
  const h = String(dt.getHours()).padStart(2,"0");
  const m = String(dt.getMinutes()).padStart(2,"0");
  return `${h}:${m}`;
}
function minutesBetween(a,b){
  const ms = new Date(b) - new Date(a);
  return Math.max(0, Math.floor(ms/60000));
}
function minutesToHHMM(min){
  const h = Math.floor(min/60);
  const m = min%60;
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
}

/*** ===== Online sync (Firestore) =====
We store ONE document: tenants/{tenantId}/data/main
with fields { state: <object>, updatedAt: <ms> }
*/
function initCloud(){
  if(!firebaseConfig){ $("#cloudPill").textContent = "Cloud: off"; return; }

  try{
    firebase.initializeApp(firebaseConfig);
    cloud.db = firebase.firestore();
    cloud.doc = cloud.db.collection("tenants").doc(tenantId).collection("data").doc("main");
    cloud.enabled = true;
    $("#cloudPill").textContent = "Cloud: on";
    listenCloud();
    scheduleCloudPush(); // push local if cloud empty
  } catch(e){
    cloud.enabled = false;
    $("#cloudPill").textContent = "Cloud: error";
    console.log(e);
  }
}

function listenCloud(){
  if(!cloud.enabled) return;
  if(cloud.unsub) cloud.unsub();

  cloud.unsub = cloud.doc.onSnapshot((snap)=>{
    if(!snap.exists) return;
    const data = snap.data();
    const ts = data.updatedAt || 0;

    // ignore if it's our own recent push
    if(ts <= cloud.lastRemoteTs) return;

    // merge: remote replaces local (simple + consistent)
    if(data.state){
      state = Object.assign(defaultState(), data.state);
      cloud.lastRemoteTs = ts;
      localStorage.setItem(KEY_LOCAL, JSON.stringify(state));
      renderAll();
      toast("Synced from cloud");
    }
  });
}

function scheduleCloudPush(){
  if(!cloud.enabled) return;
  if(cloud.pushTimer) clearTimeout(cloud.pushTimer);
  cloud.pushTimer = setTimeout(pushCloud, 600); // debounce
}

async function pushCloud(){
  if(!cloud.enabled) return;
  try{
    const ts = Date.now();
    await cloud.doc.set({ state, updatedAt: ts }, { merge:true });
    cloud.lastRemoteTs = ts;
  } catch(e){
    console.log(e);
    $("#cloudPill").textContent = "Cloud: offline";
  }
}

/*** Setup manager PIN ***/
function needsSetup(){ return !state.settings.managerPinHash; }

$("#setupSave").onclick = () => {
  const p1 = $("#setupPin1").value.trim();
  const p2 = $("#setupPin2").value.trim();
  const err = $("#setupErr");
  err.textContent = "";
  if(p1.length!==6 || !isDigits(p1)){ err.textContent="PIN must be exactly 6 digits"; return; }
  if(p1!==p2){ err.textContent="PINs do not match"; return; }
  state.settings.managerPinHash = hash(p1);
  saveLocal();
  $("#setupPin1").value=""; $("#setupPin2").value="";
  toast("Manager PIN set");
  renderAll();
};

/*** Kiosk home: staff name list ***/
function renderKioskStaffButtons(){
  const box = $("#staffButtons");
  const active = state.staff.filter(s=>s.isActive).sort((a,b)=>(a.name||"").localeCompare(b.name||""));
  if(!active.length){
    box.innerHTML = `<div class="muted">No staff yet. Tap ‚ÄúManager Control‚Äù to add staff.</div>`;
    return;
  }
  box.innerHTML = active.map(s => `
  <button class="staffBtn" style="margin:6px 0;" onclick="selectStaff('${s.id}')">
    <div class="row" style="align-items:center;">
      <div style="flex:1;">
        <strong>${s.name}</strong>
      </div>
      <div class="right"><span class="pill">Tap</span></div>
    </div>
  </button>
`).join("");

}

let selectedStaff = null;
let pin4 = "";
let pinVerified = false;

window.selectStaff = function(staffId){
  selectedStaff = state.staff.find(s=>s.id===staffId) || null;
  if(!selectedStaff) return;
  pin4 = "";
  pinVerified = false;
  $("#pinStaffName").textContent = selectedStaff.name;
  $("#pinMsg").textContent = "Enter your 4-digit PIN";
  $("#btnClockIn").disabled = true;
  $("#btnClockOut").disabled = true;
  renderDots();
  show($("#kioskHome"), false);
  show($("#pinCard"), true);
};

function renderDots(){
  $("#pinDots").textContent = pin4.padEnd(4,"-").split("").map(c => c==="-"? "-" : "‚Ä¢").join("");
}

function findOpenShift(staffId){
  const open = state.shifts.filter(sh => sh.staffId===staffId && !sh.out);
  return open.length ? open[open.length-1] : null;
}

function updateClockButtons(){
  if(!selectedStaff || !pinVerified){
    $("#btnClockIn").disabled = true;
    $("#btnClockOut").disabled = true;
    return;
  }
  const open = findOpenShift(selectedStaff.id);
  if(open){
    $("#btnClockIn").disabled = true;
    $("#btnClockOut").disabled = false;
    $("#pinMsg").textContent = `You are CLOCKED IN since ${hm(open.in)} (${ymd(open.in)})`;
  } else {
    $("#btnClockIn").disabled = false;
    $("#btnClockOut").disabled = true;
    $("#pinMsg").textContent = "You are CLOCKED OUT";
  }
}

/*** PIN keypad ***/
function buildKeypad(){
  const keys = ["1","2","3","4","5","6","7","8","9","‚å´","0","OK"];
  const kp = $("#keypad");
  kp.innerHTML="";
  keys.forEach(k=>{
    const b = document.createElement("button");
    b.className="key";
    b.textContent=k;
    b.onclick = ()=>{
      if(k==="‚å´"){ if(pin4.length>0){ pin4=pin4.slice(0,-1); renderDots(); } return; }
      if(k==="OK"){ return; }
      if(pin4.length>=4) return;
      pin4 += k;
      renderDots();
      if(pin4.length===4) verifyPin();
    };
    kp.appendChild(b);
  });
}
buildKeypad();

function verifyPin(){
  if(!selectedStaff) return;
  const ok = hash(pin4) === selectedStaff.pinHash;
  pin4 = "";
  renderDots();
  if(!ok){
    pinVerified = false;
    $("#pinMsg").textContent = "Wrong PIN ‚ùå";
    toast("Wrong PIN");
    updateClockButtons();
    return;
  }
  pinVerified = true;
  toast("PIN accepted");
  updateClockButtons();
}

$("#pinCancel").onclick = () => {
  show($("#pinCard"), false);
  show($("#kioskHome"), true);
};

/*** Clock actions -> done -> back to kiosk list ***/
function doneReturn(msg){
  toast(msg);
  setTimeout(()=>{
    show($("#pinCard"), false);
    show($("#kioskHome"), true);
    selectedStaff = null;
    pinVerified = false;
    pin4 = "";
    renderDots();
    renderKioskStaffButtons();
  }, 600);
}

$("#btnClockIn").onclick = () => {
  if(!selectedStaff || !pinVerified) return;
  if(findOpenShift(selectedStaff.id)){ toast("Already clocked in"); return; }
  state.shifts.push({ id: uid(), staffId: selectedStaff.id, in: new Date().toISOString(), out: null, editedByManager:false, notes:"" });
  saveLocal();
  doneReturn("Done ‚úÖ Clocked in");
};

$("#btnClockOut").onclick = () => {
  if(!selectedStaff || !pinVerified) return;
  const open = findOpenShift(selectedStaff.id);
  if(!open){ toast("Not clocked in"); return; }
  open.out = new Date().toISOString();
  saveLocal();
  doneReturn("Done ‚úÖ Clocked out");
};

/*** Manager gate + tabs ***/
let managerUnlocked = false;
let lockTimer = null;
const AUTO_LOCK_MS = 60*1000;

function resetAutoLock(){
  if(lockTimer) clearTimeout(lockTimer);
  if(!managerUnlocked) return;
  lockTimer = setTimeout(()=> { lockManager(); toast("Manager locked"); }, AUTO_LOCK_MS);
}
["click","keydown","touchstart"].forEach(evt => document.addEventListener(evt, resetAutoLock, {passive:true}));

function lockManager(){
  managerUnlocked = false;
  show($("#managerCard"), false);
  show($("#mgrGateCard"), false);
  show($("#kioskHome"), true);
  show($("#pinCard"), false);
  $("#mgrPin").value="";
  $("#mgrErr").textContent="";
}

function openManagerGate(){
  if(needsSetup()){ toast("Set Manager PIN first"); return; }
  show($("#kioskHome"), false);
  show($("#pinCard"), false);
  show($("#mgrGateCard"), true);
  $("#mgrPin").focus();
}

$("#btnManagerFromKiosk").onclick = openManagerGate;

$("#mgrCancel").onclick = () => {
  show($("#mgrGateCard"), false);
  show($("#kioskHome"), true);
};

$("#mgrUnlock").onclick = () => {
  const p = $("#mgrPin").value.trim();
  const err = $("#mgrErr");
  err.textContent="";
  if(p.length!==6 || !isDigits(p)){ err.textContent="Enter 6 digits"; return; }
  if(hash(p) !== state.settings.managerPinHash){ err.textContent="Wrong PIN"; $("#mgrPin").value=""; return; }
  managerUnlocked = true;
  show($("#mgrGateCard"), false);
  show($("#managerCard"), true);
  switchTab("staff");
  toast("Manager unlocked");
  resetAutoLock();
};

$("#mgrLock").onclick = () => lockManager();

/*** Staff management ***/
let editingStaffId = null;

function renderStaffList(){
  const list = $("#staffList");
  const items = state.staff.slice().sort((a,b)=> (a.name||"").localeCompare(b.name||""));
  if(!items.length){ list.innerHTML = `<div class="muted">No staff yet.</div>`; return; }

  list.innerHTML = items.map(s => {
    const pill = s.isActive ? `<span class="pill">Active</span>` : `<span class="pill">Inactive</span>`;
    return `
      <div style="padding:10px 0; border-bottom:1px solid #eee; cursor:pointer;">
        <div class="row">
          <div style="flex:1;"><strong>${s.name}</strong> <span class="muted">(${fmtGBP(s.rate)}/hr)</span></div>
          <div class="right">${pill}</div>
        </div>
      </div>
    `;
  }).join("");

  Array.from(list.children).forEach((div, idx) => {
    div.onclick = () => loadStaffForEdit(items[idx]);
  });
}

function loadStaffForEdit(s){
  editingStaffId = s.id;
  $("#sName").value = s.name;
  $("#sPin").value = "";
  $("#sRate").value = String(s.rate);
  $("#staffDeactivate").disabled = !s.isActive;
  toast("Editing staff");
}

function resetStaffForm(){
  editingStaffId = null;
  $("#sName").value="";
  $("#sPin").value="";
  $("#sRate").value="";
  $("#staffErr").textContent="";
  $("#staffDeactivate").disabled = true;
}

function pinInUse(pin, excludeId=null){
  const h = hash(pin);
  return state.staff.some(s => s.id!==excludeId && s.pinHash===h);
}

$("#staffSave").onclick = () => {
  const name = $("#sName").value.trim();
  const pin = $("#sPin").value.trim();
  const rate = parseFloat($("#sRate").value.trim());
  const err = $("#staffErr");
  err.textContent="";

  if(!name){ err.textContent="Name is required"; return; }
  if(Number.isNaN(rate) || rate<=0){ err.textContent="Hourly rate must be > 0"; return; }

  if(!editingStaffId){
    if(pin.length!==4 || !isDigits(pin)){ err.textContent="PIN must be exactly 4 digits"; return; }
    if(pinInUse(pin)){ err.textContent="That PIN is already used"; return; }
    state.staff.push({ id: uid(), name, pinHash: hash(pin), rate, isActive:true });
    saveLocal();
    toast("Staff added");
    resetStaffForm();
    renderAll();
    return;
  } else {
    const s = state.staff.find(x => x.id===editingStaffId);
    if(!s){ err.textContent="Staff not found"; return; }
    s.name = name;
    s.rate = rate;

    if(pin){
      if(pin.length!==4 || !isDigits(pin)){ err.textContent="PIN must be exactly 4 digits"; return; }
      if(pinInUse(pin, s.id)){ err.textContent="That PIN is already used"; return; }
      s.pinHash = hash(pin);
    }
    saveLocal();
    toast("Staff updated");
    resetStaffForm();
    renderAll();
  }
};

$("#staffReset").onclick = resetStaffForm;

$("#staffDeactivate").onclick = () => {
  if(!editingStaffId) return;
  const s = state.staff.find(x => x.id===editingStaffId);
  if(!s) return;
  s.isActive = false;
  saveLocal();
  toast("Staff deactivated");
  resetStaffForm();
  renderAll();
};

/*** Timesheets + export + backup (same logic, online-safe) ***/
function monthRange(monthStr){
  const [y,m] = monthStr.split("-").map(Number);
  const start = new Date(y, m-1, 1, 0,0,0,0);
  const end = new Date(y, m, 1, 0,0,0,0);
  return { start, end };
}

function buildMonthlyPayroll(monthStr){
  const {start,end} = monthRange(monthStr);
  const shifts = state.shifts.filter(sh => {
    const d = new Date(sh.in);
    return d>=start && d<end;
  });

  const byStaff = new Map();
  let openCount = 0;

  for(const sh of shifts){
    if(!byStaff.has(sh.staffId)) byStaff.set(sh.staffId, { minutes:0, shifts:0, open:0 });
    const agg = byStaff.get(sh.staffId);
    agg.shifts++;
    if(!sh.out){ agg.open++; openCount++; continue; }
    agg.minutes += minutesBetween(sh.in, sh.out);
  }

  const rows = [];
  for(const s of state.staff){
    const agg = byStaff.get(s.id) || { minutes:0, shifts:0, open:0 };
    const hours = agg.minutes/60;
    const pay = hours * s.rate;
    rows.push({
      staffName: s.name,
      rate: s.rate,
      totalMinutes: agg.minutes,
      hhmm: minutesToHHMM(agg.minutes),
      hours2: money2(hours),
      pay2: money2(pay),
      shifts: agg.shifts,
      open: agg.open
    });
  }
  rows.sort((a,b)=> a.staffName.localeCompare(b.staffName));
  return { rows, openCount };
}

function renderTimesheets(){
  const monthStr = $("#monthPick").value;
  if(!monthStr){ $("#timesTable").innerHTML = `<div class="muted">Pick a month.</div>`; return; }
  const {rows, openCount} = buildMonthlyPayroll(monthStr);
  show($("#timesWarn"), openCount>0);

  $("#timesTable").innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Staff</th>
          <th class="right">Rate</th>
          <th class="right">Total (HH:MM)</th>
          <th class="right">Hours</th>
          <th class="right">Pay</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            <td>${r.staffName}</td>
            <td class="right">${fmtGBP(r.rate)}</td>
            <td class="right">${r.hhmm}</td>
            <td class="right">${r.hours2.toFixed(2)}</td>
            <td class="right">${fmtGBP(r.pay2)}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;

  renderOpenShifts(monthStr);
}

function renderOpenShifts(monthStr){
  const {start,end} = monthRange(monthStr);
  const open = state.shifts.filter(sh => {
    const d = new Date(sh.in);
    return d>=start && d<end && !sh.out;
  });

  const box = $("#openShifts");
  if(!open.length){
    box.innerHTML = `<div class="muted">No open shifts üëç</div>`;
    return;
  }

  box.innerHTML = open.map(sh=>{
    const s = state.staff.find(x=>x.id===sh.staffId);
    const name = s ? s.name : "Unknown";
    return `
      <div class="card" style="margin:8px 0; border-radius:14px;">
        <div class="row">
          <div style="flex:1;"><strong>${name}</strong></div>
          <div class="right"><span class="pill">OPEN</span></div>
        </div>
        <div class="muted">Clock-in: ${ymd(sh.in)} ${hm(sh.in)}</div>
        <div style="height:8px"></div>
        <button class="secondary" onclick="closeShift('${sh.id}')">Close Now</button>
      </div>
    `;
  }).join("");
}

window.closeShift = function(shiftId){
  const sh = state.shifts.find(x=>x.id===shiftId);
  if(!sh) return;
  sh.out = new Date().toISOString();
  sh.editedByManager = true;
  saveLocal();
  toast("Shift closed");
  renderTimesheets();
};

function payrollCSV(monthStr){
  const {rows} = buildMonthlyPayroll(monthStr);
  const header = ["Month","StaffName","HourlyRate","TotalMinutes","TotalHHMM","TotalHoursDecimal","TotalPay"];
  const lines = [header.join(",")];

  for(const r of rows){
    const cells = [
      monthStr,
      `"${String(r.staffName).replaceAll('"','""')}"`,
      r.rate.toFixed(2),
      String(r.totalMinutes),
      r.hhmm,
      r.hours2.toFixed(2),
      r.pay2.toFixed(2)
    ];
    lines.push(cells.join(","));
  }
  return lines.join("\n");
}

function downloadText(filename, text){
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

$("#btnExportCSV").onclick = () => {
  const m = $("#exportMonth").value;
  if(!m){ toast("Pick a month"); return; }
  $("#csvOut").value = payrollCSV(m);
  toast("CSV ready");
};
$("#btnCopyCSV").onclick = async () => {
  const txt = $("#csvOut").value;
  if(!txt){ toast("Nothing to copy"); return; }
  await navigator.clipboard.writeText(txt);
  toast("Copied");
};
$("#btnDownloadCSV").onclick = () => {
  const m = $("#exportMonth").value || "payroll";
  const txt = $("#csvOut").value;
  if(!txt){ toast("Generate CSV first"); return; }
  downloadText(`payroll_${m}.csv`, txt);
  toast("Downloaded");
};

$("#btnBackup").onclick = () => {
  $("#backupOut").value = JSON.stringify({ tenantId, state }, null, 2);
  toast("Backup generated");
};
$("#btnCopyBackup").onclick = async () => {
  const txt = $("#backupOut").value;
  if(!txt){ toast("Nothing to copy"); return; }
  await navigator.clipboard.writeText(txt);
  toast("Backup copied");
};
$("#btnRestore").onclick = () => {
  const txt = $("#backupOut").value.trim();
  if(!txt){ toast("Paste backup JSON first"); return; }
  try{
    const obj = JSON.parse(txt);
    if(obj.tenantId) tenantId = obj.tenantId;
    if(!obj.state || !obj.state.settings) throw new Error("bad");
    state = Object.assign(defaultState(), obj.state);
    localStorage.setItem(KEY_TENANT, tenantId);
    saveLocal();
    toast("Restored");
    lockManager();
    renderAll();
  } catch(e){
    toast("Invalid backup JSON");
  }
};

$("#btnWipe").onclick = () => {
  const confirmText = prompt("Type WIPE to delete all data:");
  if(confirmText !== "WIPE"){ $("#wipeErr").textContent="Cancelled"; return; }
  localStorage.removeItem(KEY_LOCAL);
  state = loadLocal();
  $("#wipeErr").textContent="";
  toast("All data wiped");
  lockManager();
  renderAll();
};

/*** Tabs ***/
function switchTab(which){
  show($("#paneStaff"), which==="staff");
  show($("#paneTimes"), which==="times");
  show($("#paneExport"), which==="export");
  $("#tabStaff").classList.toggle("secondary", which!=="staff");
  $("#tabTimes").classList.toggle("secondary", which!=="times");
  $("#tabExport").classList.toggle("secondary", which!=="export");
  if(which==="times") renderTimesheets();
}
$("#tabStaff").onclick = ()=> switchTab("staff");
$("#tabTimes").onclick = ()=> switchTab("times");
$("#tabExport").onclick = ()=> switchTab("export");
$("#refreshTimes").onclick = renderTimesheets;

/*** Init ***/
function initMonthPickers(){
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth()+1).padStart(2,"0");
  const val = `${y}-${m}`;
  $("#monthPick").value = val;
  $("#exportMonth").value = val;
}

function renderAll(){
  show($("#setupCard"), needsSetup());
  show($("#kioskHome"), !needsSetup() && !managerUnlocked);
  show($("#pinCard"), false);
  show($("#mgrGateCard"), false);
  renderKioskStaffButtons();
  renderStaffList();
  initMonthPickers();
}

initMonthPickers();
renderAll();
initCloud();
</script>
</body>
</html>

